!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("base"),require("core"),require("ui"),require("module-accounts"),require("module-contacts"),require("module-payments"),require("module-transactions")):"function"==typeof define&&define.amd?define(["base","core","ui","module-accounts","module-contacts","module-payments","module-transactions"],t):"object"==typeof exports?exports["widget-new-transfer"]=t(require("base"),require("core"),require("ui"),require("module-accounts"),require("module-contacts"),require("module-payments"),require("module-transactions")):e["widget-new-transfer"]=t(e.base,e.core,e.ui,e["module-accounts"],e["module-contacts"],e["module-payments"],e["module-transactions"])}(this,function(e,t,n,r,a,o,c){return function(e){function t(r){if(n[r])return n[r].exports;var a=n[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){var r;(function(e){r=function(require,e,t){"use strict";function r(e,t){t.setConfig({paymentsEndpoint:e.getPreference("paymentOrdersDataSrc")})}t.name="widgets-new-transfer";var a=n(1),o=n(2),c=n(3),u=n(4),s=n(5),d=n(6),i=n(7),l=[o.name,c.name,u.name,d.name,i.name,s.name];r.$inject=["lpWidget","lpPayments"],t.exports=a.createModule(t.name,l).controller(n(8)).directive(n(9)).run(r)}.call(t,n,t,e),!(void 0!==r&&(e.exports=r))}).call(t,n(10)(e))},function(t,n,r){t.exports=e},function(e,n,r){e.exports=t},function(e,t,r){e.exports=n},function(e,t,n){e.exports=r},function(e,t,n){e.exports=a},function(e,t,n){e.exports=o},function(e,t,n){e.exports=c},function(e,t,n){var r;r=function(require,e,t){"use strict";function n(e){e.$$phase||e.$apply()}function r(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:7&n|8).toString(16)});return t}var a=window.jQuery;e.NewTransferController=function(e,t,o,c,u,s,d,i,l,p,m,y,f,g,h,O,T,b,v){e.errors={};var C=m,M=T.api(),w=C.getPreference("autosaveContactsPreference"),S="new-transfer-form",E={RECURRING:"RECURRING",NON_RECURRING:"NON_RECURRING"},x=function(){return e.contactsModel.findByName(e.paymentOrder.counterpartyName)?!1:!e.paymentOrder.selectedCounter||e.paymentOrder.selectedCounter.name!==e.paymentOrder.counterpartyName||e.paymentOrder.selectedCounter.account!==e.paymentOrder.counterpartyIban},P=function(){var t={name:e.paymentOrder.counterpartyName};e.paymentOrder.type===e.poTypeEnum.bank?t.account=e.usTransfer?e.paymentOrder.counterpartyAccount:e.paymentOrder.counterpartyIban:e.paymentOrder.type===e.poTypeEnum.p2pEmail&&(t.email=e.paymentOrder.counterpartyEmail),e.contactsModel.currentContact=t,e.contactsModel.createCounterParty(!0),s.publish("launchpad.contacts.load")},D=function(){var t=e.paymentOrder?e.paymentOrder.isScheduledTransfer:!1;e.paymentOrder={update:!1,uuid:r(),dateAllOptions:[{id:"today",label:"Transfer today"},{id:"date",label:"Scheduled transfer"}],dateOptions:"today",isScheduledTransfer:t,scheduledTransfer:{frequency:"",every:1,intervals:[],startDate:new Date,endDate:new Date,timesToRepeat:1},urgentTransfer:!1,scheduleDate:new Date,isOpenDate:!1,instructedCurrency:"",counterpartyIban:"",counterpartyAccount:"",counterpartyEmail:"",counterpartyAddress:"",instructedAmount:"",paymentReference:"",paymentDescription:"",counterpartyName:"",date:"",saveContact:""===w?!1:u.parseBoolean(w),type:e.poTypeEnum.bank,dirty:!1}},A=function(){for(var t in e.activeTransferTab)e.activeTransferTab.hasOwnProperty(t)&&(e.activeTransferTab[t]=!1);var n=!1;for(var r in e.poTypeEnum)e.poTypeEnum.hasOwnProperty(r)&&e.poTypeEnum[r]===e.paymentOrder.type&&(e.activeTransferTab[r]=!0,n=!0);n||(e.activeTransferTab.bank=!0)},N=function(){e.$broadcast("reset",{})},R=function(){e.paymentOrderForm.counterpartyIban&&e.paymentOrder.type===e.poTypeEnum.bank&&e.paymentOrderForm.counterpartyIban.$setValidity("notEqual",e.notEqualAccounts())},I=function(t){return t.type=e.poTypeEnum.bank,e.usTransfer?(t.counterpartyAccount=e.paymentOrder.counterpartyAccount,""!==e.paymentOrder.paymentDescription&&(t.paymentDescription=e.paymentOrder.paymentDescription)):(t.counterpartyIban=e.paymentOrder.counterpartyIban,""===e.paymentOrder.paymentReference&&""!==e.paymentOrder.paymentDescription?t.paymentDescription=e.paymentOrder.paymentDescription:""===e.paymentOrder.paymentDescription&&""!==e.paymentOrder.paymentReference&&(t.paymentReference=e.paymentOrder.paymentReference)),e.paymentOrder.isScheduledTransfer?(t.scheduledTransfer={},t.scheduledTransfer.frequency=e.paymentOrder.scheduledTransfer.frequency,t.scheduledTransfer.every=e.paymentOrder.scheduledTransfer.every,t.scheduledTransfer.intervals=e.paymentOrder.scheduledTransfer.intervals.join(","),t.scheduledTransfer.startDate=+new Date(e.paymentOrder.scheduledTransfer.startDate),t.scheduledTransfer.endDate=+new Date(e.paymentOrder.scheduledTransfer.endDate),t.paymentMode=E.RECURRING):(t.onDate=+new Date(e.paymentOrder.scheduleDate),t.paymentMode=E.NON_RECURRING,t.urgentTransfer=e.paymentOrder.urgentTransfer),t},F=function(t){return t.type=e.poTypeEnum.p2pEmail,t.onDate=+new Date(e.paymentOrder.scheduleDate),t.paymentMode=E.NON_RECURRING,t.counterpartyEmail=e.paymentOrder.counterpartyEmail,t},$=function(t){return t.type=e.poTypeEnum.p2pAddress,t.onDate=+new Date(e.paymentOrder.scheduleDate),t.paymentMode=E.NON_RECURRING,t.counterpartyAddress=e.paymentOrder.counterpartyAddress,t},U=function(){var t=u.getWidgetBaseUrl(C)+"/partials";e.mediaDir=u.getWidgetBaseUrl(C)+"/media",e.todaysDate=new Date,e.poTypeEnum=O,e.p2pService=h,e.p2pService.getUserEnrollmentDetails().then(function(t){e.userEnrolledForP2P=!0},function(t){s.subscribe("launchpad-retail.userP2PEnrolled",function(t){e.userEnrolledForP2P=t.enrolled}),404===t.status&&(e.userEnrolledForP2P=!1,e.p2pUserEnrollment={email:"",mobile:"",receivingAccountNumber:"",customerId:""})}),e.urgentTranfer=!1,e.locale=C.getPreference("locale"),e.usTransfer="en-US"===e.locale,e.title=C.getPreference("title"),e.accountsTopBalance=C.getPreferenceFromParents("defaultBalanceView")||"current",e.disableCurrencySelection=C.getPreference("disableCurrencySelection"),e.modalShown=!1,e.exchangeRateModalShown=!1,e.ibanModalShown=!1,e.routingModalShown=!1,e.templates={saveContacts:t+"/saveContacts.html",urgentTransfer:t+"/urgentTransfer.html",exchangeRate:t+"/exchangeRate.html",iban:t+"/iban.html",routingAndAccount:t+"/routingAndAccountNumber.html"},y.loadMessages(C,e.locale).success(function(t){e.messages=t.messages}),e.accountsModel=d,e.accountsModel.setConfig({accountsEndpoint:C.getPreference("accountsDataSrc")}),e.paymentOrderModel=M.createModel(),e.dateOptions={"show-button-bar":!1,"show-weeks":!1},e.selectAccount=function(t){e.accountsModel.accounts&&(a.each(e.accountsModel.accounts,function(n,r){t.accountId===r.id&&(e.accountsModel.selected=r)}),n(e))};var r=e.accountsModel.load();if(r.then(function(){u.parseBoolean(C.getPreference("forceAccountSelection"))||(!e.accountsModel.selected&&e.accountsModel.accounts&&e.accountsModel.accounts.length>0&&(e.accountsModel.selected=e.accountsModel.findByAccountNumber(C.getPreferenceFromParents("defaultAccount"))||e.accountsModel.accounts[0]),s.subscribe("launchpad-retail.accountSelected",e.selectAccount))})["catch"](function(){e.accountsModel.error="accountsLoadFailed"}),e.currencyModel=l.getInstance({defaultCurrencyEndpoint:C.getPreference("defaultCurrencyEndpoint"),currencyListEndpoint:C.getPreference("currencyListEndpoint")}),e.currencyModel.loadDefaultCurrency().success(function(t){e.currencyModel.configureDefaultCurrency(t),e.paymentOrder.instructedCurrency=""===e.paymentOrder.instructedCurrency?e.currencyModel.defaultCurrency.currency_code:e.paymentOrder.instructedCurrency,e.currencyModel.loadOtherCurrencies().success(function(){var t=""===e.paymentOrder.instructedCurrency?e.currencyModel.defaultCurrency.currency_code:e.paymentOrder.instructedCurrency;e.currencyModel.selectCurrency(t)})}),e.contactsModel=new i({contacts:u.resolvePortalPlaceholders(C.getPreference("contactListDataSrc")),contactData:u.resolvePortalPlaceholders(C.getPreference("contactDataSrc")),contactDetails:u.resolvePortalPlaceholders(C.getPreference("contactDetailsDataSrc"))}),e.contactsModel.loadContacts(),e.ibanModel=p.getInstance({countryListEndpoint:C.getPreference("ibanDataSrc"),enableCountrySearch:u.parseBoolean(C.getPreference("enableIbanCountrySearch"))}),e.ibanModel.loadCountryList().then(function(t){e.ibanModel.validate()}),D(),e.toggleTabs={oneTime:e.paymentOrder.isScheduledTransfer?!1:!0,scheduled:e.paymentOrder.isScheduledTransfer?!0:!1},e.activeTransferTab={bank:!0,p2pEmail:!1,p2pAddress:!1},e.persistenceManager=g.getInstance(),e.persistenceManager.isFormSaved(S)){var o=e.persistenceManager.getFormData(S),m=["uuid","scheduleDate","update"];for(var f in o)o.hasOwnProperty(f)&&-1===m.indexOf(f)&&(e.paymentOrder[f]=o[f]);A()}C.addEventListener("PerspectiveModified",function(t){("Minimized"===t.newValue||"Widget"===t.newValue)&&e.hideAllModals()}),e.$watch("paymentOrder",function(t,n){t!==n&&(e.persistenceManager.saveFormData(S,e.paymentOrder),t&&t.type!==e.poTypeEnum.bank&&e.setScheduledTransfer("one-time"))},!0),s.subscribe("launchpad-retail.requestMoneyTransfer.setTab",function(t){t.tab&&(e.paymentOrder.type=t.tab,A())}),s.subscribe("lpMoneyTransfer.update",function(t){e.paymentOrder=t,e.currencyModel.selectCurrency(e.paymentOrder.instructedCurrency),c(function(){e.selectAccount(t)})}),n(e)};e.openCalendar=function(t){("click"===t.type||32===t.which||13===t.which)&&(t.preventDefault(),t.stopPropagation(),e.paymentOrder.isOpenDate=!0)},e.setPaymentOrderType=function(t){e.paymentOrder.type=t},e.submitForm=function(t){var n;t.preventDefault(),e.persistenceManager.removeFormData(S),R();var r=!0;if(e.paymentOrderForm.submitted=!0,e.paymentOrderForm.$invalid)return e.$broadcast("lp.retail.new-transfer.errors"),!1;var a=M.createModel(),o=e.accountsModel.selected;switch(a.uuid=e.paymentOrder.uuid,a.counterpartyName=e.paymentOrder.counterpartyName,a.instructedAmount=e.paymentOrder.instructedAmount,a.instructedCurrency=e.paymentOrder.instructedCurrency,""===a.instructedCurrency&&(a.instructedCurrency=o.currency),a.accountId=o.id,a.accountName=o.alias,e.paymentOrder.type){case e.poTypeEnum.bank:a=I(a);break;case e.poTypeEnum.p2pEmail:e.userEnrolledForP2P||e.p2pService.enrollUserForP2P({email:e.p2pUserEnrollment.email,accountNumber:e.p2pUserEnrollment.receivingAccountNumber}).then(function(e){s.publish("launchpad-retail.userP2PEnrolled",{enrolled:!0}),s.publish("launchpad-retail.p2pEnrollmentComplete",{verified:!0})},function(t){e.p2pService.error="An error occurred while connecting to the P2P Service",r=!1}),a=F(a);break;case e.poTypeEnum.p2pAddress:e.userEnrolledForP2P||e.p2pService.enrollUserForP2P({email:e.p2pUserEnrollment.email,accountNumber:e.p2pUserEnrollment.receivingAccountNumber}).then(function(e){},function(t){e.p2pService.error="An error occurred while connecting to the P2P Service",r=!1}),a=$(a);break;default:a=I(a)}e.paymentOrder.saveContact&&x()&&P(),r&&(n=a.createOrder(a),n.then(function(t){v.trigger("newPaymentOrderInitiated"),s.publish("Launcher:openWidget",{widgetName:"review-transfers-v1"}),s.publish("launchpad-retail.paymentOrderInitiated",{paymentId:a.id}),e.resetForm()},function(t){e.errors.updateServerError=!0,c(function(){e.errors.updateServerError=!1},5e3),console.log("Server error: "+t.statusText)}))},e.onSaveContactsChange=function(){""===w&&e.paymentOrder.saveContact&&e.toggleModal()},e.setContactPreference=function(t){w=!!t,C.model.setPreference("autosaveContactsPreference",""+w),C.model.save(),e.toggleModal()},e.showContactsInfo=function(){e.showContactsOptions=!1,e.toggleModal()},e.toggleSaveToContactsModal=function(){e.showContactsOptions=!e.showContactsOptions},e.toggleAutosuggest=function(){a(C.body).find("[name=counterpartyName]").trigger("toggle.autosuggest")},e.cancelForm=function(){s.publish("launchpad-retail.closeActivePanel")},e.resetForm=function(){D(),N(),A(),e.currencyModel.selectCurrency(e.currencyModel.defaultCurrency.currency_code),e.paymentOrderForm.submitted=!1,e.paymentOrderForm.$setPristine(),e.persistenceManager.removeFormData(S)},e.resetCounterparty=function(){e.$apply(function(){e.paymentOrder.counterpartyIban=""})},e.updateCounterparty=function(t){return null===t||void 0===t?(e.paymentOrder.counterpartyIban="",e.paymentOrder.type===e.poTypeEnum.bank?e.usTransfer?e.paymentOrder.counterpartyAccount="":e.paymentOrder.counterpartyIban="":e.paymentOrder.type===e.poTypeEnum.p2pEmail&&(e.paymentOrder.counterpartyEmail=""),void e.paymentOrderForm.$setDirty()):(e.paymentOrder.selectedCounter={name:e.paymentOrder.counterpartyName,account:t.account},e.paymentOrder.type=t.type,A(),e.paymentOrder.type===e.poTypeEnum.bank?e.usTransfer?e.paymentOrder.counterpartyAccount=t.account:e.paymentOrder.counterpartyIban=t.account:e.paymentOrder.type===e.poTypeEnum.p2pEmail&&(e.paymentOrder.counterpartyEmail=t.account),void e.paymentOrderForm.$setDirty())},e.notEqualAccounts=function(){return e.accountsModel.selected?e.accountsModel.selected.iban!==e.paymentOrder.counterpartyIban:!1},e.onAccountChange=function(){R()},e.toggleModal=function(){e.showContactsOptions=!e.showContactsOptions},e.toggleExchangeRateModal=function(){e.exchangeRateModalShown=!e.exchangeRateModalShown},e.toggleSaveContactDetailsModal=function(){e.modalShown=!e.modalShown},e.toggleIbanModal=function(){e.ibanModalShown=!e.ibanModalShown},e.toggleRoutingNumberModal=function(){e.routingModalShown=!e.routingModalShown},e.hideAllModals=function(){e.urgentTransferModalShown=!1,e.exchangeRateModalShown=!1,e.ibanModalShown=!1,e.modalShown=!1},e.toggleUrgentTransferModal=function(){e.urgentTransferModalShown=!e.urgentTransferModalShown},e.setScheduledTransfer=function(t){"scheduled"===t?(e.paymentOrder.isScheduledTransfer=!0,e.toggleTabs.oneTime=!1,e.toggleTabs.scheduled=!0):"one-time"===t&&(e.paymentOrder.isScheduledTransfer=!1,e.toggleTabs.oneTime=!0,e.toggleTabs.scheduled=!1)},e.$on("reset",function(){e.paymentOrder.isScheduledTransfer=!1,e.toggleTabs.oneTime=!0,e.toggleTabs.scheduled=!1}),C.addEventListener("preferencesSaved",function(){C.refreshHTML(),U()}),b.enable(o).rule({"max-width":200,then:function(){e.responsiveClass="lp-tile-size",n(e)}}).rule({"min-width":201,"max-width":350,then:function(){e.responsiveClass="lp-small-size",n(e)}}).rule({"min-width":351,"max-width":600,then:function(){e.responsiveClass="lp-medium-size",n(e)}}).rule({"min-width":601,then:function(){e.responsiveClass="lp-large-size",n(e)}}),U()},e.NewTransferController.$inject=["$scope","$rootScope","$rootElement","$timeout","lpCoreUtils","lpCoreBus","AccountsModel","ContactsModel","CurrencyModel","IbanModel","lpWidget","i18nUtils","customerId","formDataPersistence","P2PService","transferTypes","lpPayments","lpUIResponsive","lpCoreUpdate"]}.call(t,n,t,e),!(void 0!==r&&(e.exports=r))},function(e,t,n){var r;r=function(require,e,t){"use strict";var n=window.jQuery;e.lpTransactionUpdateLayout=function(e,t){return{restrict:"A",scope:{paymentOrder:"=lpTransactionUpdateLayout"},link:function(r,a,o,c){var u=n(a[0]).closest(".lp-launcher-area"),s=u.find(".close"),d=u.find(".widget-title span"),i=d.text();r.$watch("paymentOrder.update",function(e){t(e?function(){d.text("Update Transfer")}:function(){d.text(i)})}),s.click(function(){r.paymentOrder.update=!1}),e.subscribe("launchpad-retail.closeActivePanel",function(){r.paymentOrder.update=!1})}}},e.lpTransactionUpdateLayout.$inject=["lpCoreBus","$timeout"],e.lpFutureTime=function(){return{require:"?ngModel",link:function(e,t,n,r){var a=new Date;a.setDate(a.getDate()-1),a=a.getTime(),r.$parsers.unshift(function(e){var t;return e?(t=Date.parse(e),isNaN(t)||0>t?(r.$setValidity("lpFutureTime",!1),e):a>=t?(r.$setValidity("lpFutureTime",!1),e):(r.$setValidity("lpFutureTime",!0),e)):(r.$setValidity("lpFutureTime",!0),null)})}}},e.lpSmartsuggest=function(e,t,r,a){return{restrict:"A",scope:{lpSmartsuggestSelect:"&",lpSmartsuggestClear:"&",contacts:"=lpContacts",accounts:"=lpAccounts",model:"=ngModel"},link:function(t,o,c){var u=new r({showTitles:!0});u.addSuggester({data:[],suggest:r.builtIn.getContactSuggestions}),t.$watch("accounts",function(e){u.addSuggester({data:e,suggest:r.builtIn.getAccountSuggestions,type:r.types.ACCOUNT,options:{showAll:!0}})}),t.$watch("contacts",function(t){e.isArray(t)&&u.addSuggester({data:t,suggest:r.builtIn.getContactSuggestions,type:r.types.CONTACT,options:{showAll:!0}})});var s=new a({locale:"en-US"});t.$watch("model",function(){t.$eval(c.ngModel+" = model")}),t.$watch(c.ngModel,function(e){t.model=e}),n(o).autosuggest({lookup:function(e){var t=u.getSuggestions(e);return t=t.map(function(e){var t,n=s.format(e);return t=e.contact?e.contact.name:2===n.length?n[0]+" to "+n[1]:n[0],{data:e,value:t}})},onSelect:function(e){var n,a;if(e.data.type===r.types.TITLE)return!1;switch(e.data.type){case r.types.CONTACT:a=e.data.contact.name,n=e.data.contact.account;break;case r.types.ACCOUNT:a=e.data.account.name,n=e.data.account.iban}return t.model=a,t.lpSmartsuggestSelect({account:n}),!1},onClear:function(){t.lpSmartsuggestClear()},formatResult:function(e){return s.getSuggestionHtml(e.data)},autoSelectFirst:!1,minChars:0})}}},e.lpSmartsuggest.$inject=["lpCoreUtils","ContactsModel","SmartSuggestEngine","SmartSuggestFormatter"]}.call(t,n,t,e),!(void 0!==r&&(e.exports=r))},function(e,t,n){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}}])});