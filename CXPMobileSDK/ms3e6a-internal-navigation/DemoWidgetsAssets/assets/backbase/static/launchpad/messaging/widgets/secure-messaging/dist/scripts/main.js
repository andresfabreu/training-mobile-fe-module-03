!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("base"),require("ui"),require("core"),require("module-users"),require("hammerjs")):"function"==typeof define&&define.amd?define(["base","ui","core","module-users","hammerjs"],t):"object"==typeof exports?exports["widget-secure-messaging"]=t(require("base"),require("ui"),require("core"),require("module-users"),require("hammerjs")):e["widget-secure-messaging"]=t(e.base,e.ui,e.core,e["module-users"],e.hammerjs)}(this,function(e,t,r,n,s){return function(e){function t(n){if(r[n])return r[n].exports;var s=r[n]={exports:{},id:n,loaded:!1};return e[n].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var n;(function(e){n=function(require,e,t){"use strict";t.name="secure-messaging";var n=r(1),s=r(2),a=r(3),i=r(4),o=[a.name,s.name,i.name];t.exports=n.createModule(t.name,o).factory(r(5)).service(r(6)).controller(r(7)).directive(r(8))}.call(t,r,t,e),!(void 0!==n&&(e.exports=n))}).call(t,r(10)(e))},function(t,r,n){t.exports=e},function(e,r,n){e.exports=t},function(e,t,n){e.exports=r},function(e,t,r){e.exports=n},function(e,t,r){var n;n=function(require,e){"use strict";var t=window.lp&&window.lp.util&&window.lp.util.generateUUID,r=function(){return window.b$&&window.b$.portal&&window.b$.portal.loggedInUserId};e.SharedData=function(e){var t=e,r=function(e){var t=/CN=([^,]+)/i;if(t.test(e)){var r=t.exec(e);return r[1]}return e},n=function(e,r){var n=-1;return t.forEach(e,function(t){return t.id===r?n=e.indexOf(t):void 0}),n},s=function(e,t){var r=n(e,t.id);-1!==r?e[r]=t:e.unshift(t)},a=function(e,t){var r=n(e,t.id);-1!==r&&e.splice(r,1)},i=function(){return 0===this.threads.unread.length&&0===this.threads.read.length&&0===this.draftLetters.length&&0===this.threads.archived.length};return{threads:{unread:[],read:[],archived:[]},draftLetters:[],addToList:s,removeFromList:a,selectedThread:null,editLetter:null,alerts:[],loading:!1,editLetterInd:!1,resolveDisplayName:r,isInboxEmpty:i}},e.SharedData.$inject=["lpCoreUtils"],e.Thread=function(e,t,r){var n=r,s=n.resolvePortalPlaceholders(t.getPreference("threadSrc"));return e(s,{},{queryActive:{method:"GET",params:{},isArray:!0},queryArchived:{method:"GET",params:{status:"archived"},isArray:!0},querySent:{method:"GET",params:{status:"sent"},isArray:!0},messages:{method:"GET",params:{threadId:"@id",itemType:"messages"},isArray:!0},letters:{method:"GET",params:{threadId:"@id",itemType:"letters"},isArray:!0},remove:{method:"DELETE",params:{threadId:"@id"}},archive:{method:"POST",params:{threadId:"@id",action:"archive_thread_request"}}})},e.Thread.$inject=["$resource","lpWidget","lpCoreUtils"],e.Message=function(e,t,r){var n=r,s=n.resolvePortalPlaceholders(t.getPreference("threadSrc"));return e(s,{},{markAsRead:{method:"POST",params:{threadId:"@threadId",itemType:"messages",itemId:"@id",action:"read_message_request"}}})},e.Message.$inject=["$resource","lpWidget","lpCoreUtils"],e.Letter=function(e,n,s){var a=s,i=a.resolvePortalPlaceholders(n.getPreference("letterSrc")),o=e(i,{},{query:{method:"GET",params:{action:"drafts"},isArray:!0},save:{method:"PUT",params:{action:"save",letterId:"@id"}},send:{method:"POST",params:{action:"send",letterId:"@id"}},remove:{method:"DELETE",params:{action:"delete",letterId:"@id"}},respond:{method:"PUT",params:{action:"response",threadId:"@threadId",letterId:"@id"}}});return o.create=function(){return new o({id:t(),sender:r()})},o},e.Letter.$inject=["$resource","lpWidget","lpCoreUtils"]}.call(t,r,t,e),!(void 0!==n&&(e.exports=n))},function(e,t,r){var n;n=function(require,e){"use strict";e.AlertsManager=function(e,t){var r=3e3,n=[];this.list=function(){return n},this.push=function(t,s,a){var i=this;i.close(),n.push({type:s||"danger",msg:t}),a!==!1&&e(function(){i.close()},r)},this.close=function(){n=[]}},e.AlertsManager.$inject=["$timeout","$resource"]}.call(t,r,t,e),!(void 0!==n&&(e.exports=n))},function(e,t,r){var n;n=function(require,e){"use strict";var t=window.jQuery;e.MessageController=function(e,r,n,s,a,i,o,d,c,l){e.templatesDir=l.getWidgetBaseUrl(n)+"/templates/",e.alerts=a,e.shared=s,e.categories=n.getPreference("categoryList").split(","),e.MSG_AUTOSAVE_TIMEOUT=500,e.loadThreads=function(e){var n=[],d=[];e&&(s.loading=!0),r.all({active:i.queryActive({},function(e){t.each(e,function(){this.logoPath=c(s.resolveDisplayName(this.otherUser),55,55),this.containsUnread?n.push(this):d.push(this)}),s.threads.unread=n,s.threads.read=d}).$promise,archived:i.queryArchived({},function(e){t.each(e,function(){this.logoPath=c(s.resolveDisplayName(this.otherUser),55,55),this.status="ARCHIVED"}),s.threads.archived=e}).$promise,sent:i.querySent({},function(e){t.each(e,function(){this.logoPath=c(s.resolveDisplayName(this.otherUser),55,55),this.status="SENT"}),s.threads.sent=e}).$promise,drafts:o.query({},function(e){t.each(e,function(){this.status="DRAFT",this.timestamp=this.updatedDate}),s.draftLetters=e}).$promise}).then(function(e){s.loading=!1},function(e){s.loading=!1,a.push("SERVICE_UNAVAILABLE","danger",!1)})},e.selectThreadAction=function(n){var a=r.defer();return null!==e.shared.selectedThread&&e.shared.selectedThread.id===n.id?(e.closeContentAction(),a.resolve(),a):("DRAFT"===n.status?(e.createEditLetterAction(t.extend({},n)),a.resolve()):(e.shared.selectedThread=n,e.isThreadLoading=!0,i.messages({threadId:n.id}).$promise.then(function(r){e.shared.selectedThread.messages=[],t.each(r,function(t,n){var a=new d(n);a.logoPath=c(s.resolveDisplayName(a.sender),55,55),a.senderName=e.shared.resolveDisplayName(a.sender),"UNREAD"===a.status&&(a.show=!0,a.$markAsRead({threadId:e.shared.selectedThread.id})),t+1===r.length&&(e.shared.selectedThread.lastMessageIdInThread=a.id),e.shared.selectedThread.messages.push(a)}),e.isThreadLoading=!1}),i.letters({threadId:n.id}).$promise.then(function(t){e.shared.selectedThread.draft=null,t.length>0&&(e.shared.selectedThread.draft=new o(t[0]),e.shared.selectedThread.draft.threadId=e.shared.selectedThread.id),a.resolve()})),window.scrollTo(0,0),a)},e.closeContentAction=function(){e.shared.selectedThread=null},e.createEditLetterAction=function(t){null!==t&&void 0!==t&&(e.shared.editLetter=t),e.shared.editLetterInd=!0,e.closeContentAction()},e.showSideContent=function(){return null!==e.shared.selectedThread||e.shared.editLetterInd},e.loadThreads(!0)},e.MessageController.$inject=["$scope","$q","lpWidget","SharedData","AlertsManager","Thread","Letter","Message","lpDefaultProfileImage","lpCoreUtils"],e.CreateLetterController=function(e,r,n,s,a,i,o){var d=o;e.shared=n,e.alertsManager=s,e.availableRecipients=[];var c=d.resolvePortalPlaceholders(a.getPreference("recipientsSrc"));r(c).get().$promise.then(function(r){t.each(r.addresses,function(t,r){var n={address:r};n.name=e.shared.resolveDisplayName(r),e.availableRecipients.push(n)})}),e.letter=null!==e.shared.editLetter?e.shared.editLetter:i.create();var l=function(e){"string"==typeof e.recipients&&(e.recipients=[e.recipients]),e.timestamp=new Date,e.status="DRAFT"};e.save=function(t,r){l(t),t.$save().then(function(e){n.addToList(n.draftLetters,t),s.push("SAVE_SUCCESSFULLY","success",!0)},function(e){s.push("SAVE_ERROR","danger",!1)}),e.close(r)},e.send=function(t,r){l(t),t.$save().then(function(e){t.$send().then(function(e){n.removeFromList(n.draftLetters,t),s.push("SEND_SUCCESSFULLY","success",!0)},function(e){s.push("SEND_ERROR","danger",!1)})}),e.close(r)},e.close=function(t){e.shared.editLetterInd=!1,e.shared.editLetter=null,t.newMessageForm.$setPristine(),t.newMessageForm.submitted=!1}},e.CreateLetterController.$inject=["$scope","$resource","SharedData","AlertsManager","lpWidget","Letter","lpCoreUtils"]}.call(t,r,t,e),!(void 0!==n&&(e.exports=n))},function(e,t,r){var n;n=function(require,e){"use strict";var t=r(9),n=window.jQuery;e.messageList=function(e,t,r,n,s,a){var i=s.getWidgetBaseUrl(n)+"/templates";return{restrict:"E",scope:{title:"@",items:"="},replace:!0,templateUrl:i+"/message-list.html",link:function(n,s,i){var o=function(e){null!==n.shared.selectedThread&&e.id===n.shared.selectedThread.id&&(n.shared.selectedThread=null)},d=function(e){return e?decodeURIComponent(e):a()};n.showList=!0,n.shared=t,n.toggleVisibility=function(){n.showList=!n.showList},n.picture=function(e){return d(e)},n.select=function(e){return n.$parent.selectThreadAction(e)},n.expanded=function(){return n.$parent.showSideContent()},n.selectedItem=function(){return n.shared.selectedThread},n.quickReply=function(t){null===n.shared.selectedThread||n.shared.selectedThread.id!==t.id?n.$parent.selectThreadAction(t).done(function(){e.$broadcast("initiateReply")}):e.$broadcast("initiateReply")},n.quickDelete=function(e){"DRAFT"===e.status?e.$remove().then(function(r){o(e),t.removeFromList(t.draftLetters,e)},function(e){r.push("DELETE_ERROR","danger",!1)}):e.$remove().then(function(r){o(e),"ARCHIVED"!==e.status?e.containsUnread?t.removeFromList(t.threads.unread,e):t.removeFromList(t.threads.read,e):t.removeFromList(t.threads.archived,e)},function(e){r.push("DELETE_ERROR","danger",!1)})},n.quickArchive=function(e){e.$archive().then(function(r){e.status="ARCHIVED",e.containsUnread?t.removeFromList(t.threads.unread,e):t.removeFromList(t.threads.read,e),t.addToList(t.threads.archived,e)})}}}},e.messageList.$inject=["$rootScope","SharedData","AlertsManager","lpWidget","lpCoreUtils","lpDefaultProfileImage"],e.messageContent=function(e,t,r,s,a){var i=a.getWidgetBaseUrl(s)+"/templates";return{restrict:"E",scope:{thread:"="},replace:!0,templateUrl:i+"/message-content.html",link:function(s,a,i){s.replySaveInProgressInd=!1;var o=null;s.$on("initiateReply",function(){s.openReplyAction()}),s.toggleMessageVisibility=function(e){e.isLastInThread||(e.show=!e.show)},s.openReplyAction=function(){null===s.thread.draft&&(s.thread.draft=r.create(),s.thread.draft.threadId=s.thread.id),setTimeout(function(){n("#replyMessageFormBody").focus(),n("#replyMessageFormBody").on("input propertychange",function(){null!==s.thread.draft&&(clearTimeout(o),o=setTimeout(function(){s.saveReplyAction(s.thread.draft)},s.$parent.MSG_AUTOSAVE_TIMEOUT))})},s.$parent.MSG_AUTOSAVE_TIMEOUT)},s.cancelReplyAction=function(e){null!==s.thread.draft&&(s.thread.draft.$remove(),s.clearReplyAction(e))},s.clearReplyAction=function(e){s.thread.draft=null,e.replyMessageForm.$setPristine(),e.replyMessageForm.submitted=!1},s.saveReplyAction=function(t){s.replySaveInProgressInd=!0,t.$respond().then(function(t){e(function(){s.replySaveInProgressInd=!1},s.$parent.MSG_AUTOSAVE_TIMEOUT)})},s.sendReplyAction=function(e){e.$respond().then(function(r){e.$send().then(function(e){t.push("SEND_SUCCESSFULLY","success",!0)},function(e){t.push("SEND_ERROR","danger",!1)})},function(e){t.push("SEND_ERROR","danger",!1)}),this.clearReplyAction(this),this.close()},s.close=function(){s.thread=null}}}},e.messageContent.$inject=["$timeout","AlertsManager","Letter","lpWidget","lpCoreUtils"],e.threadItemCounter=function(){return{restrict:"E",scope:{count:"@"},replace:!0,template:'<div class="vertical-middle" style="background-color: #6c6c6c; width: 22px; height: 22px; position:absolute; top:0px; right: 0px; color:#fff; text-align: center;"><span style="vertical-align: middle; font-weight: bold;">{{ count }}</span></div>'}},e.swipe=function(){return{restrict:"A",scope:{},replace:!0,link:function(e,r,s){var a=new t(r[0]);a.on("panleft",function(e){n(this).toggleClass("swipe-on")})}}}}.call(t,r,t,e),!(void 0!==n&&(e.exports=n))},function(e,t,r){e.exports=s},function(e,t,r){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}}])});